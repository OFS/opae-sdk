name: Build RPMs

on: [push]

jobs:
  centos7_6:
    runs-on: ubuntu-latest
    name: CentOS 7.6
    steps:
      - uses: actions/checkout@v2
      - name: Docker
        run: |
          cat << 'EOF' > Dockerfile
          FROM centos:7.6.1810
          RUN yum install -y python-devel python3 python3-pip python3-devel python3-pybind11 cmake make libuuid-devel json-c-devel gcc clang gcc-c++  vim hwloc-devel tbb-devel gdb doxygen python-sphinx fontawesome-fonts fontawesome-fonts-web python3-breathe python3-recommonmark python3-sphinx_rtd_theme fedora-review rpm-build rpmdevtools git
          WORKDIR /root
          ENTRYPOINT [ "/bin/bash", "-c" ]
          EOF
          docker build . -t opae-centos7.6
          cat << 'EOF' > buildit.sh
          #!/bin/bash
          mkdir centos7.6
          cd centos7.6
          cmake .. -DOPAE_BUILD_LEGACY=ON -DOPAE_PYTHON_VERSION=3.6
          make package_rpm
          EOF
          chmod a+x ./buildit.sh
          docker run --rm -v ${{ github.workspace }}:/root opae-centos7.6 ./buildit.sh
      - name: Upload Artifact
        uses: actions/upload-artifact@v2.1.4
        with:
          name: OPAE-CentOS-7.6
          path:
            centos7.6/*.rpm

