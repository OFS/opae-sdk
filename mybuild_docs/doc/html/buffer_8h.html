<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OPAE C API: include/opae/buffer.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OPAE C API
   &#160;<span id="projectnumber">-..</span>
   </div>
   <div id="projectbrief">FPGA API</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_d44c64559bbebec7f509842c48db8b23.html">include</a></li><li class="navelem"><a class="el" href="dir_beaf459716867cfd62f7e910a709c36d.html">opae</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">buffer.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Functions for allocating and sharing system memory with an FPGA accelerator.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;<a class="el" href="types_8h_source.html">opae/types.h</a>&gt;</code><br />
</div>
<p><a href="buffer_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:aac3ed0146bc42c35f99610a319e87303"><td class="memItemLeft" align="right" valign="top"><a class="el" href="types__enum_8h.html#a27aaa9bd2d94c9b53602b1a7af49fc6d">fpga_result</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="buffer_8h.html#aac3ed0146bc42c35f99610a319e87303">fpgaPrepareBuffer</a> (<a class="el" href="types_8h.html#a4ad40f31195233b629bcde187b0556d5">fpga_handle</a> handle, uint64_t len, void **buf_addr, uint64_t *wsid, int flags)</td></tr>
<tr class="separator:aac3ed0146bc42c35f99610a319e87303"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3d2302d336bbe5fe05a08a8f534d296b"><td class="memItemLeft" align="right" valign="top"><a class="el" href="types__enum_8h.html#a27aaa9bd2d94c9b53602b1a7af49fc6d">fpga_result</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="buffer_8h.html#a3d2302d336bbe5fe05a08a8f534d296b">fpgaReleaseBuffer</a> (<a class="el" href="types_8h.html#a4ad40f31195233b629bcde187b0556d5">fpga_handle</a> handle, uint64_t wsid)</td></tr>
<tr class="separator:a3d2302d336bbe5fe05a08a8f534d296b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed20b8768e38a5414a331dd09a2aa221"><td class="memItemLeft" align="right" valign="top"><a class="el" href="types__enum_8h.html#a27aaa9bd2d94c9b53602b1a7af49fc6d">fpga_result</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="buffer_8h.html#aed20b8768e38a5414a331dd09a2aa221">fpgaGetIOAddress</a> (<a class="el" href="types_8h.html#a4ad40f31195233b629bcde187b0556d5">fpga_handle</a> handle, uint64_t wsid, uint64_t *ioaddr)</td></tr>
<tr class="separator:aed20b8768e38a5414a331dd09a2aa221"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afd9f338886cc152d82fe7d211404771d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="types__enum_8h.html#a27aaa9bd2d94c9b53602b1a7af49fc6d">fpga_result</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="buffer_8h.html#afd9f338886cc152d82fe7d211404771d">fpgaBindSVA</a> (<a class="el" href="types_8h.html#a4ad40f31195233b629bcde187b0556d5">fpga_handle</a> handle, uint32_t *pasid)</td></tr>
<tr class="separator:afd9f338886cc152d82fe7d211404771d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Functions for allocating and sharing system memory with an FPGA accelerator. </p>
<p>To share memory between a software application and an FPGA accelerator, these functions set up system components (e.g. an IOMMU) to allow accelerator access to a provided memory region.</p>
<p>There are a number of restrictions on what memory can be shared, depending on platform capabilities. Usually, FPGA accelerators to not have access to virtual address mappings of the CPU, so they can only access physical addresses. To support this, the OPAE C library on Linux uses hugepages to allocate large, contiguous pages of physical memory that can be shared with an accelerator. It also supports sharing memory that has already been allocated by an application, as long as that memory satisfies the requirements of being physically contigous and page-aligned. </p>

<p class="definition">Definition in file <a class="el" href="buffer_8h_source.html">buffer.h</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="aac3ed0146bc42c35f99610a319e87303"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aac3ed0146bc42c35f99610a319e87303">&#9670;&nbsp;</a></span>fpgaPrepareBuffer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="types__enum_8h.html#a27aaa9bd2d94c9b53602b1a7af49fc6d">fpga_result</a> fpgaPrepareBuffer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="types_8h.html#a4ad40f31195233b629bcde187b0556d5">fpga_handle</a>&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void **&#160;</td>
          <td class="paramname"><em>buf_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t *&#160;</td>
          <td class="paramname"><em>wsid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Prepare a shared memory buffer</p>
<p>Prepares a memory buffer for shared access between an accelerator and the calling process. This may either include allocation of physical memory, or preparation of already allocated memory for sharing. The latter case is indicated by supplying the FPGA_BUF_PREALLOCATED flag.</p>
<p>This function will ask the driver to pin the indicated memory (make it non-swappable), and program the IOMMU to allow access from the accelerator. If the buffer was not pre-allocated (flag FPGA_BUF_PREALLOCATED), the function will also allocate physical memory of the requested size and map the memory into the caller's process' virtual address space. It returns in 'wsid' an fpga_buffer object that can be used to program address registers in the accelerator for shared access to the memory.</p>
<p>When using FPGA_BUF_PREALLOCATED, the input len must be a non-zero multiple of the page size, else the function returns FPGA_INVALID_PARAM. When not using FPGA_BUF_PREALLOCATED, the input len is rounded up to the nearest multiple of page size.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">handle</td><td>Handle to previously opened accelerator resource </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">len</td><td>Length of the buffer to allocate/prepare in bytes </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">buf_addr</td><td>Virtual address of buffer. Contents may be NULL (OS will choose mapping) or non-NULL (OS will take contents as a hint for the virtual address). </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">wsid</td><td>Handle to the allocated/prepared buffer to be used with other functions </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">flags</td><td>Flags. FPGA_BUF_PREALLOCATED indicates that memory pointed at in '*buf_addr' is already allocated an mapped into virtual memory. FPGA_BUF_READ_ONLY pins pages with only read access from the FPGA. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>FPGA_OK on success. FPGA_NO_MEMORY if the requested memory could not be allocated. FPGA_INVALID_PARAM if invalid parameters were provided, or if the parameter combination is not valid. FPGA_EXCEPTION if an internal exception occurred while trying to access the handle.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>As a special case, when FPGA_BUF_PREALLOCATED is present in flags, if len == 0 and buf_addr == NULL, then the function returns FPGA_OK if pre-allocated buffers are supported. In this case, a return value other than FPGA_OK indicates that pre-allocated buffers are not supported. </dd></dl>

<p class="reference">Referenced by <a class="el" href="hello__fpga_8c_source.html#l00314">main()</a>.</p>

</div>
</div>
<a id="a3d2302d336bbe5fe05a08a8f534d296b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3d2302d336bbe5fe05a08a8f534d296b">&#9670;&nbsp;</a></span>fpgaReleaseBuffer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="types__enum_8h.html#a27aaa9bd2d94c9b53602b1a7af49fc6d">fpga_result</a> fpgaReleaseBuffer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="types_8h.html#a4ad40f31195233b629bcde187b0556d5">fpga_handle</a>&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>wsid</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Release a shared memory buffer</p>
<p>Releases a previously prepared shared buffer. If the buffer was allocated using fpgaPrepareBuffer (FPGA_BUF_PREALLOCATED was not specified), this call will deallocate/free that memory. Otherwise, it will only be returned to it's previous state (pinned/unpinned, cached/non-cached).</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">handle</td><td>Handle to previously opened accelerator resource </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">wsid</td><td>Handle to the allocated/prepared buffer </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>FPGA_OK on success. FPGA_INVALID_PARAM if invalid parameters were provided, or if the parameter combination is not valid. FPGA_EXCEPTION if an internal exception occurred while trying to access the handle. </dd></dl>

<p class="reference">Referenced by <a class="el" href="hello__fpga_8c_source.html#l00314">main()</a>.</p>

</div>
</div>
<a id="aed20b8768e38a5414a331dd09a2aa221"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aed20b8768e38a5414a331dd09a2aa221">&#9670;&nbsp;</a></span>fpgaGetIOAddress()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="types__enum_8h.html#a27aaa9bd2d94c9b53602b1a7af49fc6d">fpga_result</a> fpgaGetIOAddress </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="types_8h.html#a4ad40f31195233b629bcde187b0556d5">fpga_handle</a>&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t&#160;</td>
          <td class="paramname"><em>wsid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint64_t *&#160;</td>
          <td class="paramname"><em>ioaddr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Retrieve base IO address for buffer</p>
<p>This function is used to acquire the physical base address (on some platforms called IO Virtual Address or IOVA) for a shared buffer identified by wsid.</p>
<dl class="section note"><dt>Note</dt><dd>This function will disappear once the APIs for secure sharing of buffer addresses is implemented.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">handle</td><td>Handle to previously opened accelerator resource </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">wsid</td><td>Buffer handle / workspace ID referring to the buffer for which the IO address is requested </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ioaddr</td><td>Pointer to memory where the IO address will be returned </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>FPGA_OK on success. FPGA_INVALID_PARAM if invalid parameters were provided, or if the parameter combination is not valid. FPGA_EXCEPTION if an internal exception occurred while trying to access the handle. FPGA_NOT_FOUND if <code>wsid</code> does not refer to a previously shared buffer. </dd></dl>

<p class="reference">Referenced by <a class="el" href="hello__fpga_8c_source.html#l00314">main()</a>.</p>

</div>
</div>
<a id="afd9f338886cc152d82fe7d211404771d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afd9f338886cc152d82fe7d211404771d">&#9670;&nbsp;</a></span>fpgaBindSVA()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="types__enum_8h.html#a27aaa9bd2d94c9b53602b1a7af49fc6d">fpga_result</a> fpgaBindSVA </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="types_8h.html#a4ad40f31195233b629bcde187b0556d5">fpga_handle</a>&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t *&#160;</td>
          <td class="paramname"><em>pasid</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Bind IOMMU shared virtual addressing</p>
<p>When PCIe PASID, ATS and PRS capabilities are enabled, some platforms support binding the IOMMU to user space virtual addresses.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">handle</td><td>Handle to previously opened accelerator resource </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">pasid</td><td>Process address space ID, set if not NULL. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>FPGA_OK on success and FPGA_NOT_SUPPORTED otherwise. </dd></dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
